# KYC Verification Portal - Setup & Configuration

## âœ… Authentication Bypass Configuration

The KYC verification portal has been configured to bypass authentication in **all** the necessary places, just like the vendor portal.

### Files Updated

All files where `/vendor-portal` was configured to bypass auth have been updated to also include `/vendor/kyc/verify`:

#### 1. **Middleware** (Primary Auth Check)

- âœ… `apps/potta/middleware.ts` - Line 27
- âœ… `apps/potta/middleware.improved.ts` - Line 27

**Purpose:** Prevents the middleware from requiring authentication cookies/headers for KYC routes.

#### 2. **Auth Configuration**

- âœ… `apps/potta/config/auth.config.ts` - Lines 91, 107

**Purpose:** Central configuration file that defines which routes bypass authentication across the app.

#### 3. **AuthGuard Component**

- âœ… `apps/potta/src/app/_components/AuthGuard.tsx` - Line 11

**Purpose:** Client-side guard that allows access to KYC routes without checking auth state.

#### 4. **useGetUser Hook**

- âœ… `apps/potta/src/app/(routes)/auth/hooks/useGetUser.ts` - Line 148

**Purpose:** Prevents the `/whoami` API call from being made on KYC routes (since there's no user session).

---

## ğŸ” Security Model

### Token-Based Access

The KYC portal uses a **secure token** passed via URL parameters:

```
/vendor/kyc/verify?token={TOKEN}&vendorId={VENDOR_ID}&kycId={KYC_ID}
```

### Token Structure

The token is generated by the backend and includes:

- Vendor ID
- KYC Request ID
- Timestamp/Expiry
- Cryptographic signature

### Validation Flow

```
1. User clicks link in email
2. Frontend extracts token from URL
3. API validates token on every request
4. Backend checks:
   - Token signature is valid
   - Token hasn't expired
   - vendorId matches token
   - kycId matches token
5. If valid: Allow upload
   If invalid: Show error
```

---

## ğŸš€ How to Access

### Development

```
http://localhost:4200/vendor/kyc/verify?token=TEST_TOKEN&vendorId=TEST_VENDOR_ID&kycId=TEST_KYC_ID
```

### Production

```
https://app.potta.dev/vendor/kyc/verify?token={TOKEN}&vendorId={VENDOR_ID}&kycId={KYC_ID}
```

---

## ğŸ“ Complete File Structure

```
apps/potta/src/app/(routes)/vendor/kyc/verify/
â”œâ”€â”€ page.tsx                          # Main page (token validation, data fetching)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ KYCVerificationForm.tsx       # Main form UI
â”‚   â””â”€â”€ DocumentUploader.tsx          # Drag & drop upload component
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useKYCVerification.ts         # Fetch KYC data
â”‚   â”œâ”€â”€ useKYCSubmission.ts           # Submit documents
â”‚   â”œâ”€â”€ useKYCDocumentUpload.ts       # Upload individual doc
â”‚   â”œâ”€â”€ useKYCStatus.ts               # Check status
â”‚   â””â”€â”€ index.ts                      # Exports
â”œâ”€â”€ services/
â”‚   â””â”€â”€ kycService.ts                 # API service layer
â”œâ”€â”€ types/
â”‚   â””â”€â”€ index.ts                      # TypeScript types
â”œâ”€â”€ README.md                         # Full documentation
â””â”€â”€ SETUP.md                          # This file
```

---

## ğŸ”— Related Routes

### Public Routes (No Auth Required)

- `/vendor-portal` - Vendor invoice submission portal
- `/vendor/kyc/verify` - KYC document verification portal
- `/auth/*` - Authentication pages
- `/public/*` - Public assets

### Protected Routes (Auth Required)

- Everything else requires authentication

---

## ğŸ§ª Testing

### Test Access (Development)

1. Start the dev server: `npm run dev`
2. Navigate to: `http://localhost:4200/vendor/kyc/verify?token=test&vendorId=test-vendor&kycId=test-kyc`
3. Should see the KYC verification page without login redirect

### Test with Real Token

1. Generate a token from the backend
2. Send email to vendor with token link
3. Click link in email
4. Should load KYC portal directly

---

## ğŸ“Š API Endpoints

All API endpoints require the token to be passed as a query parameter:

```typescript
// Get KYC Details
GET /vendor/kyc/verify?token={TOKEN}&vendorId={VENDOR_ID}&kycId={KYC_ID}

// Submit Documents
POST /vendor/kyc/submit
Body: FormData with documents

// Upload Single Document
POST /vendor/kyc/upload-document
Body: FormData with single document

// Check Status
GET /vendor/kyc/status?token={TOKEN}&vendorId={VENDOR_ID}&kycId={KYC_ID}

// Delete Document
DELETE /vendor/kyc/document/{documentId}?token={TOKEN}&vendorId={VENDOR_ID}&kycId={KYC_ID}

// Resubmit KYC
POST /vendor/kyc/resubmit?token={TOKEN}&vendorId={VENDOR_ID}&kycId={KYC_ID}
```

---

## âš ï¸ Important Notes

1. **Token Expiration**: Tokens should have a reasonable expiry time (e.g., 7 days)
2. **One-Time Use**: Consider making tokens single-use after successful submission
3. **Rate Limiting**: Implement rate limiting on upload endpoints
4. **File Size**: Current limit is 5MB for documents, 10MB for business registration
5. **File Types**: Only JPG, PNG, and PDF are accepted
6. **HTTPS Only**: In production, ensure all requests are over HTTPS

---

## ğŸ› Troubleshooting

### "Authentication Required" Error

**Cause:** KYC route not added to bypass list  
**Solution:** Check all 5 files listed above contain `/vendor/kyc/verify`

### "Invalid Token" Error

**Cause:** Token expired, invalid, or doesn't match parameters  
**Solution:** Generate a new token from backend

### Redirect to Auth Page

**Cause:** Middleware intercepting the request  
**Solution:** Ensure middleware.ts has `/vendor/kyc/verify` in PUBLIC_PATHS

### "whoami" API Call on KYC Page

**Cause:** useGetUser hook trying to fetch user data  
**Solution:** Ensure `/vendor/kyc/verify` is in BYPASS_AUTH_ROUTES in useGetUser.ts

---

## ğŸ”„ Update Checklist

When adding new public routes similar to KYC, update these 5 files:

- [ ] `middleware.ts` - PUBLIC_PATHS array
- [ ] `middleware.improved.ts` - PUBLIC_PATHS array
- [ ] `config/auth.config.ts` - BYPASS_AUTH_ROUTES and PUBLIC_PATHS
- [ ] `src/app/_components/AuthGuard.tsx` - BYPASS_AUTH_ROUTES
- [ ] `src/app/(routes)/auth/hooks/useGetUser.ts` - BYPASS_AUTH_ROUTES

---

## ğŸ“ Support

For issues or questions about the KYC portal setup, refer to:

- Main documentation: `README.md`
- API documentation: `API_DOCUMENTATION.md`
- Architecture docs: Contact dev team





